<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Using bipartite Graphs to detect Malware campaigns</title>
  <meta name="description" content="One of the greatest problems in mapping threats today, is detect from where it’s coming all kinds of threats, if is from the same group, same person or even the same governament.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://aandersonl.github.io/2020/04/30/bipartite-graph-for-threats/">
  
  
  <link rel="alternate" type="application/rss+xml" title="$ Bit escape" href="https://aandersonl.github.io/feed.xml">

  

  
  <meta property="og:title" content="Using bipartite Graphs to detect Malware campaigns">
  <meta property="og:site_name" content="$ Bit escape">
  <meta property="og:url" content="https://aandersonl.github.io/2020/04/30/bipartite-graph-for-threats/">
  <meta property="og:description" content="One of the greatest problems in mapping threats today, is detect from where it’s coming all kinds of threats, if is from the same group, same person or even the same governament.">
  
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Using bipartite Graphs to detect Malware campaigns">
  <meta name="twitter:description" content="One of the greatest problems in mapping threats today, is detect from where it’s coming all kinds of threats, if is from the same group, same person or even the same governament.">
  
  

  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700&display=swap" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">$ Bit escape</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/aandersonl">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Using bipartite Graphs to detect Malware campaigns</h1>
    
    <p class="post-meta"><time datetime="2020-04-30T23:31:36+00:00" itemprop="datePublished">Apr 30, 2020</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/malware/">malware</a>,
      
    
      
    
      
    
      
    
  
    
    
      
        <a href="/categories/programming/">programming</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/threat-intel/">threat intel</a>
      
    
      
    
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>One of the greatest problems in mapping threats today, is detect from where it’s coming all kinds of threats, if is from the same group, same person or even the same governament.</p>

<p>In order to group everything up and make things more clear, we can use a lot of data structures for that, a good one, and very famous is a Graph, a Biptartite Graph more exactly.</p>

<p>In order to acomplish that, i wrote a simple <a href="https://github.com/AandersonL/malware-research/blob/master/bipartite_graph/mal_vis.py">Python code</a> to map all domains that is possible to find in a large dataset of PE’s files.</p>

<p>This code was inspired in the <a href="https://nostarch.com/malwaredatascience">Malware Data Science</a> book, and uses an <a href="https://en.wikipedia.org/wiki/Bipartite_graph">Bipartite Graph</a> to build two sets, Domains and Samples, and the connect each one.</p>

<h2 id="bipartite-graph">Bipartite Graph</h2>

<p><img src="https://aandersonl.github.io/assets/images/bipartite_graph/bipartite.jpg" alt="" /></p>

<p>Bipartite graph is a graph where the vertices(nodes) can be splited in two groups and be connected to each other, that way, each vertice can have multiple connections to an specific set and can be used to determine how many nodes in a give group has an relation in another group.</p>

<p>In this code, i extracted all samples strings of a given path, and applied a regex rule to extract possible domain names + loaded a valid <a href="domain_suffixes.txt">domain suffixes</a> to create an valid dictionary to extract only correct domains from the samples.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Yep, i'm using strings here
</span><span class="n">strs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">"strings"</span><span class="p">,</span> <span class="n">abs_dir</span><span class="p">]).</span><span class="n">decode</span><span class="p">()</span>
<span class="n">hosts</span> <span class="o">=</span> <span class="n">extract_hostnames</span><span class="p">(</span><span class="n">strs</span><span class="p">,</span> <span class="n">compiled_rule</span><span class="p">,</span> <span class="n">valid_domains</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hosts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Build graph
</span>    <span class="n">network</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">path</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'black'</span><span class="p">,</span> <span class="n">penwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># &lt;- This put our sample in set 1
</span>    <span class="k">for</span> <span class="n">hostname</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
        <span class="n">network</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'blue'</span><span class="p">,</span> <span class="n">penwidth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;- This put our hostname in set 2
</span>        <span class="n">network</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</code></pre></div></div>

<p>With that is possible to create an <strong><em>set of domains</em></strong> and a <strong><em>set of samples</em></strong>, and then connect each sample to a given domain and find which samples shares the same domain, thus, find and classify possible malware campaigns or a set of malware controlled by the same C2/group.</p>

<h2 id="domain-graph-of-apt1">Domain graph of <a href="https://www.fireeye.com/content/dam/fireeye-www/services/pdfs/mandiant-apt1-report.pdf">APT1</a></h2>

<p><img src="https://aandersonl.github.io/assets/images/bipartite_graph/malware_domains_apt1.png" alt="" /></p>

<h2 id="running">Running</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pip install -r requirements.txt
$ python mal_vis.py --target_path &lt;path_to_samples&gt;
</code></pre></div></div>

<p>This will generate a <a href="https://www.graphviz.org/doc/info/lang.html">DOT</a> file that you can further import in any <a href="https://www.graphviz.org/">graphviz</a> tool.</p>

<p>Again, all thanks to <a href="https://nostarch.com/malwaredatascience">Malware Data Science</a>.</p>


  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://aandersonl.github.io/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
